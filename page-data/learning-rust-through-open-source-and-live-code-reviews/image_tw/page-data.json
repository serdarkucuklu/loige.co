{"componentChunkName":"component---src-templates-blog-post-share-image-js","path":"/learning-rust-through-open-source-and-live-code-reviews/image_tw","result":{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Cloud developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"a54d4aef-eb39-506f-9049-0b4bd582f0b8","timeToRead":20,"headings":[{"value":"Our motivation","depth":2},{"value":"The project and a quick JWT primer","depth":2},{"value":"The review","depth":2},{"value":"Simplified project structure and exposing a CLI and a library","depth":2},{"value":"Document all the things","depth":2},{"value":"Convert a string to anything","depth":2},{"value":"Accept any type that can be converted to string","depth":2},{"value":"Remove code duplication","depth":2},{"value":"Improve tests for invalid strings","depth":2},{"value":"Shell scripts deserve some love too","depth":2},{"value":"Conclusion","depth":2}],"html":"<p>Hello from Luciano and Stefano! üëã</p>\n<p>In the last few years we set ourselves onto the Rust learning path. We don‚Äôt work with Rust during our daily jobs and we come to be interested in the language for different reasons (more on this later), so we decided to take it easy and invest some of our free time reading books and tutorials, watching videos about Rust and doing occasional coding challenges. Finally after about one year of sporadic studying sessions we felt ready to attempt our first open source Rust project: <a href=\"https://github.com/lmammino/jwtinfo\"><code>jwtinfo</code></a>.</p>\n<p>We recently had the pleasure to have our crate reviewed by <a href=\"https://twitter.com/timClicks\">Tim McNamara</a> of <a href=\"https://www.manning.com/books/rust-in-action\">Rust in Action</a>‚Äôs fame (one the best Rust books out there in our honest opinion!). The review was carried out live on <a href=\"https://www.twitch.tv/timclicks\">Tim‚Äôs twitch channel</a> and it gave us a lot of cues on things to improve.\nThis article serves as a summary for our experience and memorandum of all the interesting things we learned. If you are learning Rust as well, we hope you will find some of these notes useful!</p>\n<h2 id=\"our-motivation\" style=\"position:relative;\"><a href=\"#our-motivation\" aria-label=\"our motivation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Our motivation</h2>\n<p>Before getting into the weeds of what we learned, it probably makes sense for us to give you a little intro on who we are and why we are interested in Rust. If you couldn‚Äôt care less about who is writing this, just skip to the next section! üòú</p>\n<p><a href=\"https://twitter.com/loige\">Luciano</a>, considers himself a fullstack cloud developer. His career has been gravitating mostly around building web and cloud-focused products. He has been using mainly high level languages throughout his career (qBasic/VB, Php, JavaScript, Python, Go, Node.js). Node.js is his tool of choice and he is one of the co-authors of the book <a href=\"https://www.nodejsdesignpatterns.com/\">Node.js Design Patterns (Packt)</a>. He is fascinated by Rust because it unveils fundamental topics like memory management and safety which he doesn‚Äôt know much about, but he is also interested in using Rust on the web building Rust web servers and frontends with WebAssembly. If you are curious to know more about Luciano, check out the <a href=\"/about\">about section of this blog</a>.</p>\n<p><a href=\"https://twitter.com/StefanoAbalsamo\">Stefano</a> is a long time low-level C/C++ developer who got close to the world of web development in the last few years. Based on his previous experience, Stefano saw in Rust a great potential to write safe and performant code across all the stack.</p>\n<h2 id=\"the-project-and-a-quick-jwt-primer\" style=\"position:relative;\"><a href=\"#the-project-and-a-quick-jwt-primer\" aria-label=\"the project and a quick jwt primer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The project and a quick JWT primer</h2>\n<p>Just to give you a little bit of context on the project, <code>jwtinfo</code> is a simple command line application (and a library) that allows you to validate and decode a JWTs (JSON Web Tokens) and visualize the content of the ‚Äúbody‚Äù (or ‚Äúpayload‚Äù) section of the token. If you are not familiar with what JWT is, you can read this 5-minutes article called <a href=\"https://loige.co/whats-in-a-jwt\">what‚Äôs in a JWT</a>.</p>\n<p><code>jwtinfo</code> is a command line utility that allows you to see what‚Äôs inside a JWT. For instance you can run it like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jwtinfo eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code></pre></div>\n<p>And it will print:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"1234567890\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"John Doe\"</span><span class=\"token punctuation\">,</span><span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span><span class=\"token number\">1516239022</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which is essentially the <em>body</em> (or <em>payload</em>) of the token we pass as input to <code>jwtinfo</code>.</p>\n<p>Of course, <code>jwtinfo</code> will also tell you if you try to pass a token that is not valid and can‚Äôt be parsed correctly, so, in a way, you could also call it a JWT validator, even though, at this time, it does not offer any functionality to validate the token signature against a secret or a public key.</p>\n<h2 id=\"the-review\" style=\"position:relative;\"><a href=\"#the-review\" aria-label=\"the review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The review</h2>\n<p>The idea of the code review came up when Tim <a href=\"https://twitter.com/timClicks/status/1306105789245841409\">asked on Twitter what people would be interested to see in a Rust live stream</a>. Luciano took this opportunity to suggest to do some live code review of Rust beginners‚Äô crates. Tim seemed to like the idea and of course at that point we had to volunteer our project üòá</p>\n<p>After a couple of weeks Tim proceeded with the live review <a href=\"https://www.youtube.com/watch?v=1JZ1oWp3PuA\">that you can now watch on YouTube</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABQYA/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAABAppyqNFMlnP/xAAbEAACAwADAAAAAAAAAAAAAAABAwIEBRIyNP/aAAgBAQABBQJjJCWSmFhDKNbk8kjF8ze3/8QAGREAAgMBAAAAAAAAAAAAAAAAAAECAxES/9oACAEDAQE/AbJPpms//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHRAAAgIBBQAAAAAAAAAAAAAAAAECERIDEDNzof/aAAgBAQAGPwKkyUtVZPOjj9IWS7Nv/8QAGxABAAICAwAAAAAAAAAAAAAAAQARITFRcfD/2gAIAQEAAT8hfrCU8zIqYohhR1yhoroZjR5RNHU//9oADAMBAAIAAwAAABB3L//EABgRAQEAAwAAAAAAAAAAAAAAAAEAEUFR/9oACAEDAQE/EGtnbHS//8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAECAQE/EAwhcv/EAB4QAQACAgEFAAAAAAAAAAAAAAEAESFhQVGRseHw/9oACAEBAAE/ECUwMFagXHAsLVFbWCgDz3coAFmOr6O0x3Jz+XbP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/b4b92ffeb74995b250c209a78d95a742/8d3d1/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.webp 256w,\n/static/b4b92ffeb74995b250c209a78d95a742/354cf/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.webp 512w,\n/static/b4b92ffeb74995b250c209a78d95a742/03f31/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.webp 1000w\"\n          sizes=\"(max-width: 1000px) 100vw, 1000px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/b4b92ffeb74995b250c209a78d95a742/b95e4/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.jpg 256w,\n/static/b4b92ffeb74995b250c209a78d95a742/1779b/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.jpg 512w,\n/static/b4b92ffeb74995b250c209a78d95a742/dbdff/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.jpg 1000w\"\n          sizes=\"(max-width: 1000px) 100vw, 1000px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/b4b92ffeb74995b250c209a78d95a742/dbdff/timclicks-reviewing-jwtinfo-rust-crate-on-twitch.jpg\"\n          alt=\"Tim McNamara (timclicks) reviewing the jwtinfo Rust crate on Twitch\"\n          title=\"Tim McNamara (timclicks) reviewing the jwtinfo Rust crate on Twitch\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p><a href=\"https://twitter.com/loige/status/1306227257606836227\">Our ask</a> was to get some generic advice around the following topics:</p>\n<ul>\n<li>Project structure</li>\n<li>Error management</li>\n<li>Enums</li>\n<li>Exposing a lib and a cli together</li>\n<li>Testing</li>\n<li>Build process</li>\n</ul>\n<p>In hindsight, we reckon that this list might look a bit random and unclear, but nonetheless Tim managed to address most of these points and provided great insights around the concerns we had around these topics.</p>\n<p>We are going now to showcase our notes, in no special order and try to provide as much context as possible based on what we learned during the review process and even after it when we decided to go in greater depth on some of the suggested improvements.</p>\n<h2 id=\"simplified-project-structure-and-exposing-a-cli-and-a-library\" style=\"position:relative;\"><a href=\"#simplified-project-structure-and-exposing-a-cli-and-a-library\" aria-label=\"simplified project structure and exposing a cli and a library permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simplified project structure and exposing a CLI and a library</h2>\n<p>When we started working on this project we just wanted to create a simple command line tool. As we were writing the code, we realized that all the JWT parsing and validation logic could be externalized to its own external module. We didn‚Äôt really want to split the project in two, mostly for simplicity, but also because there are <a href=\"https://crates.io/search?q=jwt\">many cool JWT crates</a> out there and don‚Äôt want to compete or even try to provide feature parity with them. This is a learning project, and as such, we thought it might be nice to expose our JWT parsing layer as a library too.\nTim provided 2 interesting pieces of advice. The first one is to simplify the folder structure. It turns out we were following a pattern that was required in Rust 2015 edition, which looks like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">src/\n‚îú‚îÄ‚îÄ main.rs # our CLI app\n‚îî‚îÄ‚îÄ jwt # our internal lib for JWT parsing\n    ‚îú‚îÄ‚îÄ mod.rs\n    ‚îî‚îÄ‚îÄ test.rs</code></pre></div>\n<p>In Rust 2018 edition it is possible to avoid creating <code>mod.rs</code> files. But why would you want to avoid them in the first place? It turns out that those files tend to be quite anonymous in big projects. If you have many submodules, chances are that you will end up having many tabs open at a given point in time and they would all be saying <code>mod.rs</code>. It will probably take you a while to be able to navigate through them and find the file you were looking for. What we learned is that with Rust 2018 we could simply promote <code>src/jwt/mod.rs</code> to <code>src/jwt.rs</code>. No other code change required: all the imports still work as a charm! So now our code structure looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">src/\n‚îú‚îÄ‚îÄ main.rs\n‚îú‚îÄ‚îÄ jwt.rs\n‚îî‚îÄ‚îÄ jwt/\n    ‚îî‚îÄ‚îÄ test.rs</code></pre></div>\n<p>This seems much better, we like flatter structures and descriptive file names! If you are curious to find out more about this there is an official piece of documentation recommending <a href=\"https://doc.rust-lang.org/stable/edition-guide/rust-2018/module-system/path-clarity.html#no-more-modrs\">no more <code>mod.rs</code></a>!</p>\n<p>In order to expose the <code>jwt.rs</code> module as part of the public library we finally had to do a couple of minor changes in our <code>cargo.toml</code> and in our <code>main.rs</code>.</p>\n<p>Our <code>cargo.toml</code> needed to have new sections indicating how to compile the project for the different targets (CLI application and library). We achieved that by adding the following lines:</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">lib</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"jwtinfo\"</span>\n<span class=\"token key property\">path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"src/main.rs\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">bin</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"jwtinfo\"</span>\n<span class=\"token key property\">path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"src/main.rs\"</span></code></pre></div>\n<p>If you are wondering why <code>lib</code> comes with only one pair of square brackets while <code>bin</code> comes with two, well we had the same question too! We found an answer in the <a href=\"https://doc.rust-lang.org/cargo/reference/cargo-targets.html#configuring-a-target\">official cargo documentation</a>:</p>\n<blockquote>\n<p>The double-bracket sections like <code>[[bin]]</code> are array-of-table of TOML, which means you can write more than one <code>[[bin]]</code> section to make several executables in your crate. You can only specify one library, so <code>[lib]</code> is a normal TOML table.</p>\n</blockquote>\n<p>Once we applied these changes, everything seemed to work great. Except, when we published the changes on GitHub we started to our CI being polluted by the following warning:</p>\n<blockquote>\n<p>‚Äúfile found to be present in multiple build targets‚Äù</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAnklEQVQI131PuxLCMAzL//9ZD3Y6MHAHKTTNO86rSRpcysCEBls+Sz6ZtHAFAAcefPA+hBitg23b+l+gAC2kVzoMp3G80Ol5f1DGlpkxIQRbOBKpFOd8r0Ksa/n1t9ZIL7Nc6HQ7G8VCSOGDlL7E73H8nijEnHMpBU/UWg8/6fkV02q0tNY6B8Zgtyg3WiM11uGIFN1KStwqrQH88dcbUQHlOVT9gzQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/982f8e2f1b03b3823aa50e1451d9fd67/8d3d1/file-found-to-be-present-in-multiple-build-targets.webp 256w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/354cf/file-found-to-be-present-in-multiple-build-targets.webp 512w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/44907/file-found-to-be-present-in-multiple-build-targets.webp 1024w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/864c4/file-found-to-be-present-in-multiple-build-targets.webp 1040w\"\n          sizes=\"(max-width: 1024px) 100vw, 1024px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/982f8e2f1b03b3823aa50e1451d9fd67/85b06/file-found-to-be-present-in-multiple-build-targets.png 256w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/bc282/file-found-to-be-present-in-multiple-build-targets.png 512w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/f1720/file-found-to-be-present-in-multiple-build-targets.png 1024w,\n/static/982f8e2f1b03b3823aa50e1451d9fd67/638e9/file-found-to-be-present-in-multiple-build-targets.png 1040w\"\n          sizes=\"(max-width: 1024px) 100vw, 1024px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/982f8e2f1b03b3823aa50e1451d9fd67/f1720/file-found-to-be-present-in-multiple-build-targets.png\"\n          alt=\"File found to be present in multiple build targets - screenshot from GitHub Actions\"\n          title=\"File found to be present in multiple build targets - screenshot from GitHub Actions\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>Once again, we had to roll up our sleeves and try to figure out what this actually meant. We found the answer in a <a href=\"https://github.com/rust-lang/cargo/issues/5930\">Cargo issue</a> where Alex Chricton suggested the <a href=\"https://github.com/rust-lang/cargo/issues/5930#issuecomment-449425113\">following solution</a>:</p>\n<blockquote>\n<p>[‚Ä¶] we‚Äôd recommend either using a library or a <code>mod foo</code> pointing to the same location. If you use a shared library crate then you‚Äôll get better compile times though!</p>\n</blockquote>\n<p>So, finally we managed to resolve this issue by moving all our CLI logic into a dedicated <code>cli.rs</code> file and changed the content of the original <code>main.rs</code> into this:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">mod</span> <span class=\"token module-declaration namespace\">jwt</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[macro_use]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">crate</span> <span class=\"token module-declaration namespace\">lazy_static</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Note how we also marked the <code>jwt</code> sub-module as public, so that it is actually accessible to whoever is using the library.</p>\n<p>Finally our <code>cargo.toml</code>, now looks like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">lib</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"jwtinfo\"</span>\n<span class=\"token key property\">path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"src/main.rs\"</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token table class-name\">bin</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"jwtinfo\"</span>\n<span class=\"token key property\">path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"src/cli.rs\"</span></code></pre></div>\n<p>And our files structure looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">src/\n‚îú‚îÄ‚îÄ cli.rs\n‚îú‚îÄ‚îÄ jwt.rs\n‚îú‚îÄ‚îÄ main.rs\n‚îî‚îÄ‚îÄ jwt/\n    ‚îî‚îÄ‚îÄ test.rs</code></pre></div>\n<p>And that annoying warning disappeared. Plus, we are probably getting slightly faster compile times now! ‚ö°Ô∏è</p>\n<h2 id=\"document-all-the-things\" style=\"position:relative;\"><a href=\"#document-all-the-things\" aria-label=\"document all the things permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Document all the things</h2>\n<p>One thing that we completely neglected so far was documentation. Rust has an amazing built-in utility to be able to document the API of crates and even to publish them online.\nThere is even an official piece of documentation that gives guidance on how to write <a href=\"https://doc.rust-lang.org/book/ch14-02-publishing-to-crates-io.html#making-useful-documentation-comments\">useful documentation comments</a>.</p>\n<p>If you just want to get started with writing docs for your crates, probably the easiest thing to do is to check out the <a href=\"https://doc.rust-lang.org/stable/rust-by-example/meta/doc.html\">‚ÄúRust by example‚Äù page about documentation</a>.</p>\n<p>As you start adding documentation comments to your crate, you can simply run <code>cargo doc --open</code> to compile the website with the documentation locally and open it with your browser. This is extremely convenient to make sure that, once you publish the crate, the documentation online will look as expected.</p>\n<p>Few days after the review we rolled up our sleeves and started to document our library. If you are curious to see what it took to go from 0 to 100, this is our PR that added documentation to the crate: <a href=\"https://github.com/lmammino/jwtinfo/pull/22\">lmammino/jwtinfo/pull/22</a>.</p>\n<p>One of the most amazing thing was that, once we published a new version of the crate on crates.io, after few minutes we could navigate our crate doc online at <a href=\"https://docs.rs/jwtinfo\">docs.rs/jwtinfo</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 945px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.40624999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACOklEQVQ4y42Ty07bQBSG/SwQdVEn9vju8cx4fCMlVdIEBKGgBKldsaCSEVKCxKugLLKl4kGy4CIhSN+mv50EYkqrfhrZ4zNz7sfKZDKZTqdXV1c3Nze3t7d3dw/39w9PT0/Pz894zufzX1Ugf3x8nM1mP6+vlSRJGGNxHLdardF4NBrl5+dneX4G8jzH90WV8Xh8eXl5evojTVPl8PBwOBweHR0JIbOYp+ID0T+qan2BWlKvAgmlNIoi5eDg68nJyWAw4FxEwv/cjOI4gdUowitBRFJKXA2qUN93XVf5VvD9+PiYC5GETqfJhMB2SRiGuOr+ged5hXK/3x8OBnt7e5xz17FZYdS3bVtboes6eQ/TNJVer7e/v9/ptBFazC0euI5bWHXew66i7Ozsbm9/AkgMsURS4hLC8sus8KbUL48KCVuBMJGO0u11d0s4L2RpmuEM9xAIXQMCHGdZlpZgg3IUYS+ADqyjAaiTtwLO4cQwDHSo0WgsnosN0l5X5jIwmiFpSpNR5Oz+G2RX8SzDsNNuwzMqaf0HFWWU+U2QfwND9iZsxgIWY8Di2LatssOE6MZyEZMQ4xViWOaaZ/gkhu0EgZQhF8yluuWqxK5ZXs1warq5QexNzaip2mZdq9W1DWKoa8qMaTBHA0w13MsoDJjr0obPG1ToceYlWzRKqIxplPpJGjBGl8rdbg99+9LpoFUoI3pUdsr3vcDzMLGB4GGxxOsqhuTFcyjYVhbh33Jeu+S8rMpYrr5+A48OI9fQUBoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/c730ab1276c387d28437d2d249499621/8d3d1/jwtinfo-rust-docs-page.webp 256w,\n/static/c730ab1276c387d28437d2d249499621/354cf/jwtinfo-rust-docs-page.webp 512w,\n/static/c730ab1276c387d28437d2d249499621/0f41d/jwtinfo-rust-docs-page.webp 945w\"\n          sizes=\"(max-width: 945px) 100vw, 945px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/c730ab1276c387d28437d2d249499621/85b06/jwtinfo-rust-docs-page.png 256w,\n/static/c730ab1276c387d28437d2d249499621/bc282/jwtinfo-rust-docs-page.png 512w,\n/static/c730ab1276c387d28437d2d249499621/fddb0/jwtinfo-rust-docs-page.png 945w\"\n          sizes=\"(max-width: 945px) 100vw, 945px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/c730ab1276c387d28437d2d249499621/fddb0/jwtinfo-rust-docs-page.png\"\n          alt=\"jwtinfo Rust docs page screenshot from the rendered docs in the browser\"\n          title=\"jwtinfo Rust docs page screenshot from the rendered docs in the browser\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>Another thing that we loved about writing documentation in Rust is the ability to execute code examples to make sure they are actually correct.\nJust to show a real example, this is a piece of documentation in our crate:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">//! To parse a given JWT as a string:</span>\n<span class=\"token comment\">//!</span>\n<span class=\"token comment\">//! ```rust</span>\n<span class=\"token comment\">//! use jwtinfo::{jwt};</span>\n<span class=\"token comment\">//!</span>\n<span class=\"token comment\">//! let token_str = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\";</span>\n<span class=\"token comment\">//! match jwt::parse(token_str) {</span>\n<span class=\"token comment\">//!   Ok(token) => {</span>\n<span class=\"token comment\">//!     // do something with token</span>\n<span class=\"token comment\">//!     assert_eq!(token.header.to_string(), \"{\\\"alg\\\":\\\"HS256\\\",\\\"typ\\\":\\\"JWT\\\"}\");</span>\n<span class=\"token comment\">//!     assert_eq!(token.body.to_string(), \"{\\\"iat\\\":1516239022,\\\"name\\\":\\\"John Doe\\\",\\\"sub\\\":\\\"1234567890\\\"}\");</span>\n<span class=\"token comment\">//!   }</span>\n<span class=\"token comment\">//!   Err(e) => panic!(e)</span>\n<span class=\"token comment\">//! }</span>\n<span class=\"token comment\">//! ```</span></code></pre></div>\n<p>When we run our test suite with <code>cargo test</code>, Cargo will also extrapolate this example here from the docs and execute it. This will help us make sure that our documentation is actually correct and that it doesn‚Äôt go stale over time.</p>\n<p>If you have a big test suite and you just want to run your doc tests you can simply do that with <code>cargo test --doc</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1024px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.109375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABZ0lEQVQY003PW0vCcBgG8He1mXN5SM05dW5L8zTnnJqV2DIvSoQg6IN0k3SidDNxOtO6KIKgm7rpa0QH+lb9Syzhd/O88MDzwtv7Z6PZPtLNQ81otPoNzWxo/R96/+RycNweHOn947Y57bRzdXDWfv34gnNjCI4gwYiEV8Q9POZgwMlh8yzYQmANABkECwOEfxqOjkA2dQM082ZWlPwlVZAr3uWCg5cXInlvJO+O5Oy8YheUuVAaD6QI5h8ZkoBi9d41dIe3NlZixJKdk+18lgrLGJMAOgaeZfD+WowhmC/+B/XRqJYxAmN45+IVTlGd0VxYVunEOhVVrFzGykpUOEOyEslmbOEMKuD+5Jg1mEZPab0RXHRH4OBQxv2iLZiy0NE5JkkxSYJOzCC+OILRCXAtgVMYw91RAE+zY8LD84uk7q5W99aq+8Wt+srmdqFSL27UlHItVdoRJ9LlmjSRVeuCot4/Pn0DlKlYtfUydY4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/4eb1e27239250659e78a25f5972c1f45/8d3d1/jwtinfo-running-docs-test-with-rust-docs.webp 256w,\n/static/4eb1e27239250659e78a25f5972c1f45/354cf/jwtinfo-running-docs-test-with-rust-docs.webp 512w,\n/static/4eb1e27239250659e78a25f5972c1f45/44907/jwtinfo-running-docs-test-with-rust-docs.webp 1024w,\n/static/4eb1e27239250659e78a25f5972c1f45/c17ae/jwtinfo-running-docs-test-with-rust-docs.webp 1032w\"\n          sizes=\"(max-width: 1024px) 100vw, 1024px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/4eb1e27239250659e78a25f5972c1f45/85b06/jwtinfo-running-docs-test-with-rust-docs.png 256w,\n/static/4eb1e27239250659e78a25f5972c1f45/bc282/jwtinfo-running-docs-test-with-rust-docs.png 512w,\n/static/4eb1e27239250659e78a25f5972c1f45/f1720/jwtinfo-running-docs-test-with-rust-docs.png 1024w,\n/static/4eb1e27239250659e78a25f5972c1f45/aef12/jwtinfo-running-docs-test-with-rust-docs.png 1032w\"\n          sizes=\"(max-width: 1024px) 100vw, 1024px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/4eb1e27239250659e78a25f5972c1f45/f1720/jwtinfo-running-docs-test-with-rust-docs.png\"\n          alt=\"Running docs tests with rust test --doc\"\n          title=\"Running docs tests with rust test --doc\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n    </span></p>\n<p>Finally, another small trick we discovered is that you can hide specific functions or types from the generated documentation (in case those are private details you don‚Äôt want to expose to the crate users). Hiding documentation members is as simple as adding the following annotation:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[doc(hidden)]</span></code></pre></div>\n<p>For instance, in our crate we have:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[doc(hidden)]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">parse_base64_string</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JWTParseError</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token namespace\">base64<span class=\"token punctuation\">::</span></span><span class=\"token function\">decode_config</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token constant\">BASE64_CONFIG</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">str</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_utf8</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is convenient because we don‚Äôt want any user of our crate to bother with this function which is just an implementation detail that we might decide to change in the future.</p>\n<h2 id=\"convert-a-string-to-anything\" style=\"position:relative;\"><a href=\"#convert-a-string-to-anything\" aria-label=\"convert a string to anything permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Convert a string to anything</h2>\n<p>Another great suggestion from Tim to improve the ergonomics of the JWT parsing library was to implement the <a href=\"https://doc.rust-lang.org/std/str/trait.FromStr.html\"><code>str::FromStr</code> trait</a> for the <code>Token</code> type.</p>\n<p>The <code>FromStr</code> trait is a special Rust trait that allows to convert a string into any type that implements the trait.</p>\n<p>This trait is already implemented in some standard type like <code>int32</code> and is what allows us to convert a string to an <code>int32</code> as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token string\">\"1987\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">i32</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>By the way, if you find the syntax <code>function::&#x3C;type>()</code> weird, don‚Äôt worry, we found it a bit ‚Äúunfriendly‚Äù too. Once we discovered it is called <em>‚Äúturbofish‚Äù</em> we couldn‚Äôt help but to fall in love with it. You can learn more about it here: <a href=\"https://matematikaadit.github.io/posts/rust-turbofish.html\">Where to put the turbofish</a>.</p>\n<p>Don‚Äôt worry, if you still don‚Äôt like the turbofish syntax, you can rewrite the code above using type hints as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token string\">\"1987\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> result <span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The official docs as a great example that shows how the <code>str::FromStr</code> trait can be very valuable to implement in your custom types. We are going to try to take this example and present it here in a slightly simplified fashion.</p>\n<p>Imagine you have defined a <code>Point</code> type as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[derive(Debug, PartialEq)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Point</span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span>\n    y<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now imagine you are processing data from a text source, let‚Äôs say a file, and in there points are encoded in a string format such as <code>17,22</code>. Wouldn‚Äôt it be nice to be able to easily turn this format of strings into <code>Point</code> values?</p>\n<p>Well, let‚Äôs enable this using the <code>str::FromStr</code> trait:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span></span><span class=\"token keyword\">str</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">FromStr</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>num<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">ParseIntError</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[derive(Debug)]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Point</span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">,</span>\n    y<span class=\"token punctuation\">:</span> <span class=\"token keyword\">i32</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">FromStr</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">Point</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Err</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">ParseIntError</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">from_str</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">Self</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">Self</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Err</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> parts <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> x_str <span class=\"token operator\">=</span> parts<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> y_str <span class=\"token operator\">=</span> parts<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> x_str<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">i32</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> y_str<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">i32</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Point</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">,</span> y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> value <span class=\"token operator\">=</span> <span class=\"token string\">\"17,22\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> point <span class=\"token operator\">=</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Point</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{:?}\"</span><span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Point { x: 17, y: 22 }</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see from the example above, the <code>str::FromStr</code> trait has the following spec:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">impl</span> <span class=\"token class-name\">FromStr</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">YourType</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Err</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">YourErrorType</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">from_str</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">Self</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">Self</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Err</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// process the string `s` and return a Result</span>\n        <span class=\"token comment\">// either a Err(YourErrorType) or</span>\n        <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">YourType</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In our project it was rather trivial to implement this trait, because our <code>parse</code> function matches quite closely the signature of the <code>from_str</code> method defined in the  <code>str::FromStr</code> trait:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">impl</span> <span class=\"token class-name\">FromStr</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">Token</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span> <span class=\"token class-name\">Err</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">JWTParsePartError</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">from_str</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">Self</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">Self</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Err</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This allows for the following syntax:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> token <span class=\"token operator\">=</span> <span class=\"token string\">\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token namespace\">jwt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Token</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>or, if you still hate the poor turbofish:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> token<span class=\"token punctuation\">:</span> <span class=\"token namespace\">jwt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Token</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"accept-any-type-that-can-be-converted-to-string\" style=\"position:relative;\"><a href=\"#accept-any-type-that-can-be-converted-to-string\" aria-label=\"accept any type that can be converted to string permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Accept any type that can be converted to string</h2>\n<p>For better or for worse, Rust is famous for having a number of different types to represent strings. The most famous are <a href=\"https://doc.rust-lang.org/stable/rust-by-example/std/str.html\"><code>String</code> and <code>&#x26;str</code></a> but from time to time we have seen even other types like <a href=\"https://doc.rust-lang.org/std/ffi/struct.CStr.html\"><code>CStr</code></a> or <a href=\"https://doc.rust-lang.org/std/ffi/struct.OsStr.html\"><code>OsStr</code></a>.</p>\n<p>During the review process, Tim recommended making our public API more flexible by supporting ‚Äúevery type that can be converted to a string‚Äù.</p>\n<p>The way we can achieve that is by leveraging the <a href=\"https://doc.rust-lang.org/std/convert/trait.AsRef.html\"><code>std::convert::AsRef</code></a> trait.</p>\n<p>The official documentation starts with a ‚Äúnot very friendly‚Äù opening (at least for Rust noobs like ourselves), but then it provides a great example that makes quite obvious how to use this trait to support any type of string:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">is_hello</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AsRef</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">str</span><span class=\"token operator\">>></span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token macro property\">assert_eq!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">as_ref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">is_hello</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">is_hello</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Essentially, whenever you want to accept ‚Äúanything that can be converted to a string‚Äù you can use the following recipe:</p>\n<ol>\n<li>Make your function accept an argument <code>x</code> of generic type <code>T</code></li>\n<li>Define <code>T</code> so that it must implement the trait <code>AsRef&#x3C;str></code></li>\n<li>In your function body get the actual <code>str</code> value from <code>x</code> using <code>x.as_ref()</code></li>\n</ol>\n<p>As you can see from the example above, with this recipe, we can pass both <code>&#x26;str</code> and <code>String</code> values to the <code>is_hello</code> function.</p>\n<p>Applying this pattern to our code was quite straightforward. Also, since our public surface is quite small, we only needed to change the <code>jwt::parse</code> function as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">parse</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">AsRef</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">str</span><span class=\"token operator\">>></span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Token</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JWTParsePartError</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> parts <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">as_ref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token char string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"remove-code-duplication\" style=\"position:relative;\"><a href=\"#remove-code-duplication\" aria-label=\"remove code duplication permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remove code duplication</h2>\n<p>One of the things that amazed us when we started playing with Rust was to discover that Rust <a href=\"https://doc.rust-lang.org/reference/statements-and-expressions.html\"><em>is primarily an expression language</em></a>.</p>\n<p>In practice, this means that most syntax elements, including <code>if-else</code> and <code>match</code>, once evaluated will produce a value that can be carried over to other expressions or assigned to a variable.</p>\n<p>Coming from languages that don‚Äôt have this capability, we easily forget to take advantage of this characteristic of Rust and we end up writing code that contains duplication or that is more verbose than necessary.</p>\n<p>Tim spotted a few places where we could get rid of annoying code duplication by simply using <code>match</code> and <code>if-else</code> in a different way. This made us go through the code base of our crate and find other places where we could improve readability and make our code more idiomatic.</p>\n<p>Let‚Äôs show some examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">if</span> matches<span class=\"token punctuation\">.</span><span class=\"token function\">is_present</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> jwt_token<span class=\"token punctuation\">.</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> jwt_token<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This code has clearly some repetition. It is not terrible, but it seems unnecessary to have to repeat the <code>println!()</code> macro invocation and the <code>to_string()</code> call.</p>\n<p>We ended up refactoring this as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> part <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> matches<span class=\"token punctuation\">.</span><span class=\"token function\">is_present</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    jwt_token<span class=\"token punctuation\">.</span>header\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    jwt_token<span class=\"token punctuation\">.</span>body\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> part<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Once you know that <code>if-else</code> expressions will produce a value (depending on which branch will be selected at runtime), this alternative looks more readable. Also this refactoring makes quite clear that this code has essentially 2 parts: select a part, then print it on the standard output.</p>\n<p>Another interesting example in our code base involved the <code>match</code> expression. This was the code before the refactoring:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">impl</span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Display</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">JWTParseError</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">fmt</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Formatter</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Result</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">match</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">JWTParseError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MissingSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token macro property\">write!</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Missing token section\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">JWTParseError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">InvalidUtf8</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token macro property\">write!</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token string\">\"UTF8 error, {}\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">JWTParseError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">InvalidBase64</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token macro property\">write!</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Base64 error, {}\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">JWTParseError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">InvalidJSON</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token macro property\">write!</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JSON error, {}\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Applying the same principle as before we refactored the code above to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">impl</span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Display</span> <span class=\"token keyword\">for</span> <span class=\"token class-name\">JWTParseError</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">fmt</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Formatter</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token namespace\">fmt<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Result</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> message <span class=\"token operator\">=</span> <span class=\"token keyword\">match</span> <span class=\"token keyword\">self</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">JWTParseError</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MissingSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token class-name\">Missing</span> token section<span class=\"token string\">\".to_string(),\n            JWTParseError::InvalidUtf8(e) => format!(\"</span><span class=\"token constant\">UTF8</span> error<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token string\">\", e),\n            JWTParseError::InvalidBase64(e) => format!(\"</span><span class=\"token class-name\">Base64</span> error<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token string\">\", e),\n            JWTParseError::InvalidJSON(e) => format!(\"</span><span class=\"token constant\">JSON</span> error<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token string\">\", e),\n        };\n        write!(f, \"</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\"<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Again, the trick here is to assign the result of the match expression to a variable (<code>message</code> in this particular case) and then we can re-use that variable in the next step.</p>\n<p>Another cool thing that we discovered is that, by using <a href=\"https://github.com/rust-lang/rust-clippy\">clippy</a> as a linter, it will help you out to spot some of these improvements.</p>\n<p>For instance, the first time we tried to improve the readability of the <code>if-else</code> expression previously mentioned we ended up using a <code>match</code> expression unnecessarily:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> part <span class=\"token operator\">=</span> <span class=\"token keyword\">match</span> matches<span class=\"token punctuation\">.</span><span class=\"token function\">is_present</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token boolean\">true</span> <span class=\"token operator\">=></span> jwt_token<span class=\"token punctuation\">.</span>header<span class=\"token punctuation\">,</span>\n    <span class=\"token boolean\">false</span> <span class=\"token operator\">=></span> jwt_token<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> part<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When we run clippy on this code, it did trigger the <a href=\"https://rust-lang.github.io/rust-clippy/master/index.html#match_bool\"><code>match_bool</code></a> rule and that it is suggested to refactor this with an <code>if-else</code> expression:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> part <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> matches<span class=\"token punctuation\">.</span><span class=\"token function\">is_present</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    jwt_token<span class=\"token punctuation\">.</span>header\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    jwt_token<span class=\"token punctuation\">.</span>body\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Which is indeed more readable. Another lesson learned: trust linters!</p>\n<p>In short, these types of change helped us to reduce the amount of inline composition and to make the code more sequential and easy to follow.</p>\n<h2 id=\"improve-tests-for-invalid-strings\" style=\"position:relative;\"><a href=\"#improve-tests-for-invalid-strings\" aria-label=\"improve tests for invalid strings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Improve tests for invalid strings</h2>\n<p>Another thing that Tim recommended us to do was to improve our coverage on testing different types of input. He tried to run our JWT parser against strings with non-utf8 characters and strings containing null bytes to see whether our code would handle that correctly (returning an error) or whether it would just panic.</p>\n<p>The idea is to try to avoid panics at all costs and make sure all possible errors are handled and propagated correctly.</p>\n<p>This pushed us to increase our test coverage adding a few more tests as you can see in <a href=\"https://github.com/lmammino/jwtinfo/pull/28/files\">this PR</a>.</p>\n<p>Another interesting recommendation was to use something like <a href=\"https://github.com/BurntSushi/quickcheck\">quickcheck</a> to do fuzzy testing on our input. Although this seems like an extremely interesting thing to do, we haven‚Äôt got time yet to play with this idea.</p>\n<h2 id=\"shell-scripts-deserve-some-love-too\" style=\"position:relative;\"><a href=\"#shell-scripts-deserve-some-love-too\" aria-label=\"shell scripts deserve some love too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shell scripts deserve some love too</h2>\n<p>As a last point, Tim had a look at our <a href=\"https://github.com/lmammino/jwtinfo/blob/master/install.sh\">cross-system installation script</a> and immediately noticed our poor use of Bash scripting.</p>\n<p>The main advice here was to use some shell linter like <a href=\"https://www.shellcheck.net\">Shellcheck</a>. Tim himself, ran the script against the linter by copy pasting the code on the web page and submitted a PR with some improvements.</p>\n<p>Shellcheck can be used as a command line tool too, so it would be nice in feature release to integrate in our automated tests.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>This concludes our recap article. We don‚Äôt have any special rule of thumb except that the Rust ride was quite fun for us so far. It has been a bumpy road but thanks to the amazing open source community and people like Tim, the road to learn Rust can become much smoother.</p>\n<p>Our final word of advice is that, if you are learning Rust, or any other technology for what matters, don‚Äôt be afraid to starti public open source projects and ask for help and reviews. Even better if you share this journey with some friends.</p>\n<p>At the end of the day, all that matters is learning new things and having fun!</p>\n<p>We take one more opportunity to thank Tim for the great support here and, if you like Rust, we do recommend you to follow him on <a href=\"https://twitter.com/timClicks\">Twitter</a>, <a href=\"https://www.twitch.tv/timclicks\">Twitch</a> and <a href=\"https://www.youtube.com/channel/UClny6qj9Mv7uFo9XGUGYQBA\">Youtube</a>.</p>\n<p>Take care! üôå</p>","frontmatter":{"title":"Learning Rust through open source and live code reviews","slug":"learning-rust-through-open-source-and-live-code-reviews","author":"Luciano Mammino","tags":["rust"],"date":"October 11, 2020","header_img":{"publicURL":"/static/73964e7ee471c3ff0729c96f4bc4fb65/learning-rust-through-open-source-and-live-code-reviews.jpg"}}}},"pageContext":{"slug":"learning-rust-through-open-source-and-live-code-reviews","width":440,"height":220,"type":"twitter"}},"staticQueryHashes":[]}